import{T as L,o as v,G as Y,k as q,l as U,w as W,m as j,s as I,h as J,t as w,n as Q,c as V,d as F}from"./tools-380870f1.js";import{d as K}from"./debug-a9561137.js";import{G as X}from"./GrainPlayer-91b90a2a.js";import{A as Z}from"./AMSynth-565cb4c3.js";import{S as k}from"./Split-ba57eae4.js";import{p as b}from"./index-80725c7a.js";class S extends L{constructor(){super(v(S.getDefaults(),arguments,["type","size"])),this.name="Analyser",this._analysers=[],this._buffers=[];const t=v(S.getDefaults(),arguments,["type","size"]);this.input=this.output=this._gain=new Y({context:this.context}),this._split=new k({context:this.context,channels:t.channels}),this.input.connect(this._split),q(t.channels,1);for(let r=0;r<t.channels;r++)this._analysers[r]=this.context.createAnalyser(),this._split.connect(this._analysers[r],r,0);this.size=t.size,this.type=t.type}static getDefaults(){return Object.assign(L.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,r)=>{const n=this._buffers[r];this._type==="fft"?t.getFloatFrequencyData(n):this._type==="waveform"&&t.getFloatTimeDomainData(n)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((r,n)=>{r.fftSize=t*2,this._buffers[n]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){U(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(r=>r.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class _ extends L{constructor(){super(v(_.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new S({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class P extends _{constructor(){super(v(P.getDefaults(),arguments,["smoothing"])),this.name="Meter",this._rms=0;const t=v(P.getDefaults(),arguments,["smoothing"]);this.input=this.output=this._analyser=new S({context:this.context,size:256,type:"waveform",channels:t.channels}),this.smoothing=t.smoothing,this.normalRange=t.normalRange}static getDefaults(){return Object.assign(_.getDefaults(),{smoothing:.8,normalRange:!1,channels:1})}getLevel(){return W("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),n=(this.channels===1?[t]:t).map(s=>{const h=s.reduce((o,m)=>o+m*m,0),i=Math.sqrt(h/s.length);return this._rms=Math.max(i,this._rms*this.smoothing),this.normalRange?this._rms:j(this._rms)});return this.channels===1?n[0]:n}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}const G=()=>{const e=["right","right","left","left"],r=.5/e.length;return{marginRate:.2,loopRangeLineYPosRate:1.1,alignments:e,boxIntervalRate:.01,boxHeightRate:r,easingFMin:.05,easingFMax:.5,playbackRateMin:.3,playbackRateMax:3.5,loopRetentionFrameRateMin:.3,loopRetentionFrameRateMax:2.5,amSynthVolumeMin:-40,amSynthVolumeMax:-10,amSynthNote:["G6","D7","C7","E7"],granularVolumeMin:-15,granularVolumeMax:-3,hues:[357,237],saturations:[68,68],brightnesses:[80,80],saturationRange:15,brightnessRange:65,ampRateMin:.1,ampRateMax:.9,waveLengthRateMin:.01,waveLengthRateMax:1,waveSpeedRateMin:1e-5,waveSpeedRateMax:1e-4}};G();const tt=(e,t)=>{t.pages[1].addInput(e,"marginRate",{step:.1,min:.1,max:1})},et="/playground/assets/track_1-043a5dc7.mp3",st="/playground/assets/track_2-ea523552.mp3",E=async e=>{const t=new Q;return await t.load(e),t},A=e=>e.duration,nt=(e,t,r)=>{const n=new X(e).connect(r);return n.volume.value=-5,n.loop=!0,n.loopStart=0,n.grainSize=t,n},ot=e=>{const t=new Z;return t.connect(e),t},O=async()=>{const e=await I(),t=[await E(et),await E(st)],r=[A(t[0]),A(t[1]),A(t[0]),A(t[1])],n=r.map(()=>new J().toDestination());n.forEach((i,o)=>{i.set({pan:w.map(o,0,r.length,-1,1)})});const s=r.map((i,o)=>nt(t[o%2],i,n[o])),h=r.map((i,o)=>ot(n[o]));return{se:e,panners:n,players:s,amSynths:h,data:{durations:r}}};await O();const at=(e,t,r,n,s)=>{s==2&&e.players.forEach(h=>h.start()),t.loopRetentionFrames.forEach((h,i)=>{e.players[i].volume.value=r.amplitudes[i],h===0&&(e.panners[i].pan.value=r.panValues[i],e.players[i].reverse=t.loopIsReverses[i],e.players[i].loopStart=t.loopStartTimes[i],e.players[i].grainSize=t.loopGrainSizes[i],e.players[i].playbackRate=t.playbackRates[i])}),t.loopIsSwitches.forEach((h,i)=>{if(h===!0){const o=w.map(t.playbackRates[i],n.playbackRateMin,n.playbackRateMax,n.amSynthVolumeMin,n.amSynthVolumeMax);e.amSynths[i].volume.value=o,e.amSynths[i].triggerAttackRelease(n.amSynthNote[i],"16n")}})},rt=e=>{const t=e.data.durations,r=t.map(()=>new P);return e.players.forEach((n,s)=>n.connect(r[s])),{durations:t,volumes:r}},T=(e,t,r,n,s)=>{const h=s.currentHeights.map(o=>{const m=w.map(o,0,n.size.y,e.granularVolumeMin,e.granularVolumeMax),a=w.constrain(m,e.granularVolumeMin,e.granularVolumeMax);return isNaN(a)?0:a}),i=r.currentPositions.map(o=>w.map(o.x,0,t,-1,1));return{amplitudes:h,panValues:i}},x=(e,t,r,n)=>{const s=n===void 0,h=e.durations.reduce((y,f)=>f>y?f:y,0),i=e.durations.map((y,f)=>{if(s||n.loopRetentionFrames[f]===0){const d=w.map(Math.random(),0,1,t.loopRetentionFrameRateMin,t.loopRetentionFrameRateMax);return y*60*Math.floor(d)}return n.loopRetentionFrames[f]-1}),o=i.map(y=>y===0),m=o.map((y,f)=>s||y?w.map(Math.random(),0,1,t.playbackRateMin,t.playbackRateMax):n.playbackRates[f]),a=e.durations.map((y,f)=>s||o[f]?Math.random()*y:n.loopStartTimes[f]),p=e.durations.map((y,f)=>s||o[f]?Math.random()*y:n.loopEndTimes[f]),l=o.map((y,f)=>s?!1:y?a[f]>p[f]:n.loopIsReverses[f]),u=o.map((y,f)=>{if(s||y||n.loopIsOvers[f])return 0;const d=n.loopStampTimes[f];return r*.001-d}),g=u.map((y,f)=>y>e.durations[f]/m[f]),c=g.map((y,f)=>s||y||o[f]?r*.001:n.loopStampTimes[f]),R=u.map((y,f)=>y/e.durations[f]*m[f]),M=p.map((y,f)=>Math.abs(y-a[f]));return{longestDuration:h,loopRetentionFrames:i,loopIsSwitches:o,playbackRates:m,loopStartTimes:a,loopEndTimes:p,loopIsReverses:l,loopElapsedTimes:u,loopIsOvers:g,loopStampTimes:c,loopProgressRates:R,loopGrainSizes:M}},z=(e,t,r,n,s)=>{const h=s===void 0,i=(()=>h?r*(1-t.marginRate)/e.longestDuration:s.bufferConvertRateToLength)(),o=(()=>h?n.durations.map(l=>l*i):s.fullLengths)(),m=(()=>h?t.alignments.map((l,u)=>{const g=r*t.marginRate*.5,c=l==="right"?g:r-o[u]-g,M=r*t.boxHeightRate*t.alignments.length,y=r-M,f=t.alignments.length+1,d=y/f;return new b.Vector(c,d)}):s.margins)(),a=(()=>h?n.durations.map((l,u)=>{const g=m[u].x,c=r*t.boxHeightRate,R=m[u].y*(u+1)+c*u;return new b.Vector(g,R)}):s.startPositions)(),p=(()=>h?a.map((l,u)=>b.Vector.add(l,new b.Vector(o[u],0))):s.endPositions)();return{bufferConvertRateToLength:i,fullLengths:o,margins:m,startPositions:a,endPositions:p}},C=(e,t,r,n,s,h)=>{const i=h===void 0,o=(()=>i?s.startPositions:h.startPositions.map((g,c)=>{if(!r.loopIsSwitches[c])return g;const R=g.copy(),M=r.loopStartTimes[c]/n.durations[c],f=s.fullLengths[c]*M+s.margins[c].x;return R.x=f,R}))(),m=(()=>i?o:h.startCurrentPositions.map((g,c)=>{const R=o[c],M=R.x-g.x;if(Math.abs(M)<1)return R;const y=w.map(r.playbackRates[c],e.playbackRateMin,e.playbackRateMax,e.easingFMin,e.easingFMax),f=new b.Vector(M*y,0);return b.Vector.add(g,f)}))(),a=(()=>i?s.endPositions:h.endPositions.map((g,c)=>{if(!r.loopIsSwitches[c])return g;const R=g.copy(),M=r.loopEndTimes[c]/n.durations[c],f=s.fullLengths[c]*M+s.margins[c].x;return R.x=f,R}))(),p=(()=>i?a:h.endCurrentPositions.map((g,c)=>{const R=a[c],M=R.x-g.x;if(Math.abs(M)<1)return R;const y=w.map(r.playbackRates[c],e.playbackRateMin,e.playbackRateMax,e.easingFMin,e.easingFMax),f=new b.Vector(M*y,0);return b.Vector.add(g,f)}))(),l=o.map((g,c)=>i?0:Math.abs(a[c].x-g.x)*r.loopProgressRates[c]),u=(()=>i?n.durations.map((g,c)=>{const R=s.margins[c].x,M=t/(n.durations.length+1)*(c+1);return new b.Vector(R,M)}):h.currentPositions.map((g,c)=>r.loopIsReverses[c]?(g.x=o[c].x-l[c],g):(g.x=o[c].x+l[c],g)))();return{startPositions:o,startCurrentPositions:m,endPositions:a,endCurrentPositions:p,progresses:l,currentPositions:u}},B=(e,t,r,n,s)=>{const h=s===void 0,i=new b.Vector(t*e.boxIntervalRate,t*e.boxHeightRate),o=n.startPositions.map((l,u)=>{if(h||r.loopIsSwitches[u]){const g=l.x-n.endPositions[u].x,c=Math.ceil(Math.abs(g/i.x));return c<1?1:c}return s.counts[u]}),m=n.startPositions.map((l,u)=>h||r.loopIsSwitches[u]?Array.from(Array(o[u]),(g,c)=>{const R=r.loopIsReverses[u]?-1:1,M=new b.Vector(i.x*R*c,0);return b.Vector.add(l,M)}):s.positionArrays[u]),a=n.progresses.map((l,u)=>{if(h||r.loopIsSwitches[u]||r.loopIsOvers[u])return 0;const g=i.x*s.currentIndexes[u],c=Math.abs(l-g),R=Math.floor(c/i.x),M=s.currentIndexes[u]+R,y=m[u].length-1;return M>y?y:M}),p=a.map((l,u)=>h?0:l-s.currentIndexes[u]);return{size:i,counts:o,positionArrays:m,currentIndexes:a,addedSegments:p}},H=(e,t,r,n,s,h)=>{const i=h===void 0,o=e.loopIsSwitches.map((l,u)=>i||l?w.map(Math.random(),0,1,t.waveSpeedRateMin*r,t.waveSpeedRateMax*r):h.angleSpeeds[u]),m=s.positionArrays.map((l,u)=>{if(i||e.loopIsSwitches[u]){const g=Math.abs(n.endPositions[u].x-n.startPositions[u].x),c=w.map(Math.random(),0,1,t.waveLengthRateMin,t.waveLengthRateMax),R=g*c,M=g/R,f=Math.PI*2*M/s.counts[u];return l.map((d,N)=>f*N)}return h.angleArrays[u].map(g=>g+o[u])}),a=e.loopIsSwitches.map((l,u)=>i||l?w.map(Math.random(),0,1,t.ampRateMin*s.size.y,t.ampRateMax*s.size.y):h.amps[u]),p=s.positionArrays.map((l,u)=>{const g=a[u];return l.map((c,R)=>{const M=m[u][R],y=c.y+s.size.y*.5,f=w.map(Math.sin(M),-1,1,-.5,.5)*g;return new b.Vector(c.x,y+f)})});return{angleSpeeds:o,angleArrays:m,amps:a,positionArrays:p}},$=(e,t,r)=>{const n=r===void 0,s=(()=>{const m=new b.Vector(0,e.size.y);return e.positionArrays.map((a,p)=>a.filter((u,g)=>g<=e.currentIndexes[p]).map(u=>b.Vector.add(u,m)))})(),h=t.positionArrays.map((m,a)=>{const p=e.currentIndexes[a],l=m[p];return s[a][p].y-l.y}),i=s.map((m,a)=>{const p=h[a],l=e.addedSegments[a],u=m.length;if(n||l<0)return Array.from(Array(u),()=>p);const g=r.heightArrays[a];if(l===0)return g.map((R,M)=>M===g.length-1?p:R);const c=Array.from(Array(l),()=>p);return g.concat(c)}),o=s.map((m,a)=>m.map((p,l)=>{const u=new b.Vector(0,i[a][l]);return b.Vector.sub(p,u)}));return{LLpositionArrays:s,currentHeights:h,heightArrays:i,positionArrays:o}},D=(e,t,r,n,s)=>{const h=e.loopIsReverses.map(a=>{const p=a?0:1;return t.hues[p]}),i=e.loopIsReverses.map((a,p)=>{const l=a?1:0,u=t.saturations[l];return w.map(e.playbackRates[p],t.playbackRateMin,t.playbackRateMax,u-t.saturationRange,u+t.saturationRange)}),o=e.loopIsReverses.map(a=>{const p=a?1:0;return t.brightnesses[p]}),m=n.positionArrays.map((a,p)=>{const l=r.volumes[p].getValue(),u=isFinite(l)?l:0,g=w.map(u,-50,-20,o[p]-t.brightnessRange,o[p]+t.brightnessRange),c=w.constrain(g,o[p]-t.brightnessRange,o[p]+t.brightnessRange);if(s===void 0||e.loopIsOvers[p]||e.loopIsSwitches[p])return a.map(()=>c);const R=s.brightnessArrays[p],M=a.length-R.length;if(M===0)return R[R.length-1]=c,R;const y=Array.from(Array(M),()=>c);return R.concat(y)});return{hues:h,saturations:i,brightnesses:o,brightnessArrays:m}},it=(e,t,r,n,s,h,i,o)=>{o.push(),o.noFill(),o.strokeWeight(1),o.strokeCap(o.SQUARE),e.startPositions.forEach((m,a)=>{o.stroke(s.hues[a],s.saturations[a],s.brightnesses[a]),o.line(m.x,m.y+h.size.y*i.loopRangeLineYPosRate,e.endPositions[a].x,e.endPositions[a].y+h.size.y*i.loopRangeLineYPosRate)}),o.strokeWeight(3),o.strokeCap(o.PROJECT),t.startCurrentPositions.forEach((m,a)=>{o.push(),o.stroke(s.hues[a],s.saturations[a],s.brightnesses[a]),o.line(m.x,m.y+h.size.y*i.loopRangeLineYPosRate,t.endCurrentPositions[a].x,t.endCurrentPositions[a].y+h.size.y*i.loopRangeLineYPosRate),o.pop()}),o.pop(),o.push(),r.positionArrays.forEach((m,a)=>{const p=h.currentIndexes[a];o.stroke(s.hues[a],s.saturations[a],s.brightnesses[a]),m.forEach((l,u)=>{u>p&&o.line(l.x,l.y,l.x+h.size.x,l.y)})}),o.pop(),o.push(),o.noStroke(),n.positionArrays.forEach((m,a)=>{const p=s.hues[a],l=s.brightnessArrays[a],u=s.saturations[a],g=n.heightArrays[a];m.forEach((c,R)=>{const M=g[R],y=l[R];o.fill(p,y,u),o.rect(c.x,c.y,h.size.x,M)})}),o.pop()},mt=e=>{const t=w.setSize("sketch");let r=V.setController();const n=G();let s,h,i,o,m,a,p,l,u,g;e.setup=async()=>{h=await O(),i=rt(h),s=x(i,n,e.millis()),m=z(s,n,t,i),a=C(n,t,s,i,m),p=B(n,t,s,a),l=H(s,n,t,a,p),u=$(p,l),g=D(s,n,i,p,g),o=T(n,t,a,p,u),e.createCanvas(t,t);const c=V.setGui(e,r,h.se,!1);tt(n,c),e.colorMode(e.HSB),e.noLoop(),F(e,t)},e.draw=()=>{if(h===void 0){e.noLoop();return}e.frameCount%5===0&&K({na:"working"},10),e.background(255),V.updateController(e,r),s=x(i,n,e.millis(),s),m=z(s,n,t,i,m),a=C(n,t,s,i,m,a),p=B(n,t,s,a,p),l=H(s,n,t,a,p,l),u=$(p,l,u),g=D(s,n,i,p,g),o=T(n,t,a,p,u),it(m,a,l,u,g,p,n,e),F(e,t),at(h,s,o,n,e.frameCount)}};export{mt as sketch};
