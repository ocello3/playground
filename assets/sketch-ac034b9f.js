import{B as I,o as T,E as C,n as H,F as M,H as m,I as N,q as A,z as R,J as U,K as P,L as W,N as G,Q as J,R as K,t as v,U as $,s as Q,V as F,d as X,c as B}from"./tools-3de08622.js";import{p as x}from"./index-2134a18a.js";import{A as Y,M as Z}from"./Meter-985fbe38.js";import"./Split-da7b27bd.js";class S extends I{constructor(){super(T(S.getDefaults(),arguments,["callback","value"])),this.name="ToneEvent",this._state=new C("stopped"),this._startOffset=0;const t=T(S.getDefaults(),arguments,["callback","value"]);this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(I.getDefaults(),{callback:H,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,e=>{let s;if(e.state==="started"){e.id!==-1&&this.context.transport.clear(e.id);const i=e.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||M(this._loop)&&this._loop>1){s=1/0,M(this._loop)&&(s=this._loop*this._getLoopDuration());const o=this._state.getAfter(i);o!==null&&(s=Math.min(s,o.time-i)),s!==1/0&&(this._state.setStateAtTime("stopped",i+s+1,{id:-1}),s=new m(this.context,s));const c=new m(this.context,this._getLoopDuration());e.id=this.context.transport.scheduleRepeat(this._tick.bind(this),c,new m(this.context,i),s)}else e.id=this.context.transport.schedule(this._tick.bind(this),new m(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const e=this.toTicks(t);return this._state.getValueAtTime(e)==="stopped"&&(this._state.add({id:-1,state:"started",time:e}),this._rescheduleEvents(e)),this}stop(t){this.cancel(t);const e=this.toTicks(t);if(this._state.getValueAtTime(e)==="started"){this._state.setStateAtTime("stopped",e,{id:-1});const s=this._state.getBefore(e);let i=e;s!==null&&(i=s.time),this._rescheduleEvents(i)}return this}cancel(t){t=A(t,-1/0);const e=this.toTicks(t);return this._state.forEachFrom(e,s=>{this.context.transport.clear(s.id)}),this._state.cancel(e),this}_tick(t){const e=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(e)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;N(this.humanize)||(s=this.toSeconds(this.humanize)),t+=(Math.random()*2-1)*s}this.callback(t,this.value)}}_getLoopDuration(){return Math.round((this._loopEnd-this._loopStart)/this._playbackRate)}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new m(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new m(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,e=this._state.get(t);if(e!==null&&e.state==="started"){const s=this._getLoopDuration();return(t-e.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class z extends S{constructor(){super(T(z.getDefaults(),arguments,["callback","events"])),this.name="Part",this._state=new C("stopped"),this._events=new Set;const t=T(z.getDefaults(),arguments,["callback","events"]);this._state.increasing=!0,t.events.forEach(e=>{R(e)?this.add(e[0],e[1]):this.add(e)})}static getDefaults(){return Object.assign(S.getDefaults(),{events:[]})}start(t,e){const s=this.toTicks(t);if(this._state.getValueAtTime(s)!=="started"){e=A(e,this._loop?this._loopStart:0),this._loop?e=A(e,this._loopStart):e=A(e,0);const i=this.toTicks(e);this._state.add({id:-1,offset:i,state:"started",time:s}),this._forEach(o=>{this._startNote(o,s,i)})}return this}_startNote(t,e,s){e-=s,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<s&&(e+=this._getLoopDuration()),t.start(new m(this.context,e))):t.startOffset<this._loopStart&&t.startOffset>=s&&(t.loop=!1,t.start(new m(this.context,e))):t.startOffset>=s&&t.start(new m(this.context,e))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(e=>{e.startOffset+=this._startOffset})}stop(t){const e=this.toTicks(t);return this._state.cancel(e),this._state.setStateAtTime("stopped",e),this._forEach(s=>{s.stop(t)}),this}at(t,e){const s=new U(this.context,t).toTicks(),i=new m(this.context,1).toSeconds(),o=this._events.values();let c=o.next();for(;!c.done;){const r=c.value;if(Math.abs(s-r.startOffset)<i)return P(e)&&(r.value=e),r;c=o.next()}return P(e)?(this.add(t,e),this.at(t)):null}add(t,e){t instanceof Object&&Reflect.has(t,"time")&&(e=t,t=e.time);const s=this.toTicks(t);let i;return e instanceof S?(i=e,i.callback=this._tick.bind(this)):i=new S({callback:this._tick.bind(this),context:this.context,value:e}),i.startOffset=s,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(t){this._state.forEach(e=>{e.state==="started"?this._startNote(t,e.time,e.offset):t.stop(new m(this.context,e.time))})}remove(t,e){return W(t)&&t.hasOwnProperty("time")&&(e=t,t=e.time),t=this.toTicks(t),this._events.forEach(s=>{s.startOffset===t&&(G(e)||P(e)&&s.value===e)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(e=>e.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(e=>{e instanceof z?e._forEach(t):t(e)}),this}_setAll(t,e){this._forEach(s=>{s[t]=e})}_tick(t,e){this.mute||this.callback(t,e)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(e=>{e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.loop=t,this._testLoopBoundries(e)})}get loopEnd(){return new m(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(e=>{e.loopEnd=t,this._testLoopBoundries(e)})}get loopStart(){return new m(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(e=>{e.loopStart=this.loopStart,this._testLoopBoundries(e)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class O extends S{constructor(){super(T(O.getDefaults(),arguments,["callback","events","subdivision"])),this.name="Sequence",this._part=new z({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[];const t=T(O.getDefaults(),arguments,["callback","events","subdivision"]);this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(J(S.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,e){e!==null&&this.callback(t,e)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,e){return this._part.start(t,e&&this._indexTime(e)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new m(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(e,s)=>e[s],set:(e,s,i)=>(K(s)&&isFinite(parseInt(s,10))&&R(i)?e[s]=this._createSequence(i):e[s]=i,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,e,s){t.forEach((i,o)=>{const c=o*e+s;if(R(i))this._rescheduleSequence(i,e/i.length,c);else{const r=new m(this.context,c,"i").toSeconds();this._part.add(r,i)}})}_indexTime(t){return new m(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,t===0?this._part.loopEnd=this._indexTime(this._eventsArray.length):this._part.loopEnd=this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}const tt=(n,t,e)=>{if(!(e===void 0))return e;const i=t*n.hMargin,o=t*n.vMargin,c=i*2,r=o*(n.count+1),f=t-c,d=(t-r)/n.count,a=Array.from(Array(n.count),(l,h)=>{const p=i,u=o*(h+1)+d*h;return new x.Vector(p,u)}),g=a.map(()=>new x.Vector(f,d));return{coordinates:a,sizes:g}},q=(n,t,e)=>{const s=e===void 0,i=60/t.bpm,o=Array.from(Array(t.count),(g,l)=>`C${l}`),c=t.base.sustain*Math.pow(t.mod.release,t.count-1),r=o.map((g,l)=>{const h=t.base.attack*Math.pow(t.mod.attack,l),p=t.base.decay*Math.pow(t.mod.decay,l),u=t.base.sustain*Math.pow(t.mod.sustain,l),y=t.base.release*Math.pow(t.mod.release,l),b=i/(h+p+y),_=b<1?b:1,k=c<1?u:u/c;return{attack:v.constrain(h*_,0,2),decay:v.constrain(p*_,0,2),sustain:v.constrain(k,0,1),release:v.constrain(y*_,0,2)}}),f=o.map((g,l)=>{const h=t.base.harmonicity*Math.pow(t.mod.harmonicity,l);return{harmonicity:v.constrain(h,.01,2)}}),d=t.currentSeqId===-1?0:t.currentSeqId,a=d+1>t.count-1?0:d+1;return!s&&n.isIdChanged&&(e.am.envelope.set(r[a]),e.am.harmonicity.value=f[a].harmonicity),{seq:o,adsrs:r,amParams:f,adsrLength:i}},D=(n,t,e,s)=>{const i=s===void 0,o=n.sizes[0],c=o.x*e.hExpand,r=a=>a/t.adsrLength*c;return{envs:(i?Array.from(Array(e.count),()=>({startPos:new x.Vector(0,o.y),attackedPos:new x.Vector(0,0),decayedPos:new x.Vector(0,0),sustainedPos:new x.Vector(0,0),endPos:new x.Vector(c,o.y)})):s.envs).map((a,g)=>{const l={...a},h=t.adsrs[g],p={attack:r(h.attack),decay:r(h.decay),sustain:o.y*h.sustain,release:r(h.release)};return l.attackedPos.x=p.attack,l.decayedPos.x=l.attackedPos.x+p.decay,l.decayedPos.y=o.y-p.sustain,l.sustainedPos.x=c-p.release,l.sustainedPos.y=o.y-p.sustain,l})}},L=(n,t,e,s)=>{const i=s===void 0,o=e.currentSeqId===-1?0:e.currentSeqId,c=o!==s?.preSeqId,r=(()=>i?0:c?t.toneSec:s.timeStamp)(),f=t.toneSec-r,d=f/n.adsrLength;return{isIdChanged:c,timeStamp:r,elapsedTime:f,progress:d,preSeqId:o}},et=(n,t,e,s,i)=>{const o=i===void 0,c=e.currentSeqId===-1?0:e.currentSeqId,r=Array.from(Array(e.count),(u,y)=>y===c),f=o?n.sizes.map((u,y)=>{const b=n.sizes[y].x*e.rectWidth;return new x.Vector(b,u.y)}):i.rectSizes,d=o?r.map((u,y)=>{const b=Math.ceil(1/e.rectWidth);return Array.from(Array(b),(k,E)=>{const w=f[y].x*E,j=0;return new x.Vector(w,j)})}):i.pointArrays,a=(()=>{const u=r.findIndex(_=>_===!0),y=n.sizes[u].x*t.progress,b=d[u].findIndex(_=>_.x<y&&y<_.x+f[u].x);return{arrayIndex:u,rectIndex:b}})(),g=o?!1:c===0&&i.preSeqId===e.count-1,l=v.map(s.getValue(),-200,0,0,n.sizes[0].y),h=o||g?d.map(u=>u.map(()=>0)):i.heightArrays.map((u,y)=>r[y]?u.map((b,_)=>i.currentRectId.rectIndex<_&&_<=a.rectIndex?l:b):u);return{isDraws:r,pointArrays:d,currentRectId:a,heightArrays:h,rectSizes:f,preSeqId:c}},V=(n,t,e,s,i)=>{const o=i===void 0,c=e.envs.map((a,g)=>{const l=t.adsrs[g],h=(()=>{const _=`A: ${(Math.round(l.attack*100)*.01).toString().slice(0,4)}`,k=a.startPos;return{text:_,pos:k}})(),p=(()=>{const _=`D: ${(Math.round(l.decay*100)*.01).toString().slice(0,4)}`,k=new x.Vector(a.attackedPos.x,a.startPos.y);return{text:_,pos:k}})(),u=(()=>{const _=`S: ${(Math.round(l.sustain*100)*.01).toString().slice(0,4)}`,k=n.sizes[0].y*s.fontSize*5,E=n.sizes[0].y-a.decayedPos.y-k,w=E<0?x.Vector.add(a.decayedPos,new x.Vector(0,E)):a.decayedPos;return{text:_,pos:w}})(),y=(()=>{const _=`R: ${(Math.round(l.release*100)*.01).toString().slice(0,4)}`,E=n.sizes[0].x*s.fontSize*8-a.sustainedPos.x,w=E>0?new x.Vector(a.sustainedPos.x+E,a.startPos.y):new x.Vector(a.sustainedPos.x,a.startPos.y);return{text:_,pos:w}})();return{attack:h,decay:p,sustain:u,release:y}}),r=t.amParams.map((a,g)=>{const h=`H: ${(Math.round(a.harmonicity*100)*.01).toString().slice(0,4)}`,p=o?new x.Vector(0,n.sizes[g].y):i.amParams[g].harmonicity.pos;return{harmonicity:{text:h,pos:p}}}),d={totalLength:(()=>{const g=`totalLength: ${(Math.round(t.adsrLength*100)*.01).toString().slice(0,4)}`,l=new x.Vector(n.coordinates[0].x+n.sizes[0].x,n.coordinates[0].y);return{text:g,pos:l}})()};return{adsrs:c,amParams:r,general:d}},st=()=>({count:4,hMargin:.06,vMargin:.04,hExpand:1,rectWidth:.015,fontSize:.03,bpm:32,currentSeqId:-1,pitch:"B4",base:{attack:.4,decay:.2,sustain:.6,release:.7,harmonicity:1},mod:{attack:.5,decay:.5,sustain:.5,release:.5,harmonicity:1}}),ot=(n,t)=>{t.pages[1].addBinding(n,"hExpand",{step:1,min:1,max:10});const s=t.pages[2];s.addBinding(n,"bpm",{step:1,min:20,max:200}).on("change",i=>$.bpm.value=i.value/2),s.addBinding(n,"pitch",{view:"list",label:"pitch",options:[{text:"B0",value:"B0"},{text:"B1",value:"B1"},{text:"B2",value:"B2"},{text:"B3",value:"B3"},{text:"B4",value:"B4"},{text:"B5",value:"B5"},{text:"B6",value:"B6"},{text:"B7",value:"B7"}],value:"B4"}),s.addBinding(n.base,"attack",{label:"base_a",step:.01,min:.01,max:1}),s.addBinding(n.base,"decay",{label:"base_d",step:.01,min:.01,max:1}),s.addBinding(n.base,"sustain",{label:"base_s",step:.01,min:.01,max:1}),s.addBinding(n.base,"release",{label:"base_r",step:.01,min:.01,max:1}),s.addBinding(n.base,"harmonicity",{label:"base_h",step:.01,min:.01,max:2}),s.addButton({title:"reset",label:"mod"}).on("click",()=>{n.mod.attack=1,n.mod.decay=1,n.mod.sustain=1,n.mod.release=1,n.mod.harmonicity=1,s.refresh()}),s.addBinding(n.mod,"attack",{label:"mod_a",step:.1,min:.1,max:2}),s.addBinding(n.mod,"decay",{label:"mod_d",step:.1,min:.1,max:2}),s.addBinding(n.mod,"sustain",{label:"mod_s",step:.1,min:.1,max:2}),s.addBinding(n.mod,"release",{label:"mod_r",step:.1,min:.1,max:2}),s.addBinding(n.mod,"harmonicity",{label:"mod_h",step:.1,min:.1,max:2})},it=()=>{const n=new Y;return n.toDestination(),n},nt=n=>{const t=new Z;return n.connect(t),t},at=(n,t,e)=>{const s=new O(i=>{F.schedule(()=>{const c=e.currentSeqId+1,r=c>e.count-1||e.currentSeqId<0?0:c;e.currentSeqId=r},i),n.triggerAttackRelease(e.pitch,"32n",i)},t.seq);return s.loop=!0,$.bpm.value=e.bpm/2,s.start(0),s},rt=async(n,t)=>{const e=await Q(),s=it(),i=nt(s),o=at(s,n,t);return{se:e,am:s,meter:i,toneSeq:o}},ct=(n,t,e,s,i,o)=>{n.coordinates.forEach((c,r)=>{const f=n.sizes[r].x,d=n.sizes[r].y;o.push(),o.translate(c.x,c.y),o.stroke(1),o.push(),o.noStroke(),o.fill(150,120),o.beginShape();const a=t.envs[r];o.vertex(a.startPos.x,a.startPos.y),o.vertex(a.attackedPos.x,a.attackedPos.y),o.vertex(a.decayedPos.x,a.decayedPos.y),o.vertex(a.sustainedPos.x,a.sustainedPos.y),o.vertex(a.endPos.x,a.endPos.y),o.endShape(),o.pop(),o.push(),o.noStroke();const g=e.pointArrays[r],l=e.heightArrays[r];g.forEach((u,y)=>{o.push(),o.fill(50,150);const b=d-l[y];o.rect(u.x,u.y+b,e.rectSizes[r].x,e.rectSizes[r].y-b),o.pop()}),o.pop(),o.push(),o.stroke(70,150),o.strokeWeight(i*.005),o.strokeCap(o.ROUND),o.line(0,d,f,d),o.pop(),o.push(),o.noStroke();const h=s.adsrs[r];o.textAlign(o.LEFT,o.TOP),o.text(h.attack.text,h.attack.pos.x,h.attack.pos.y),o.textAlign(o.LEFT,o.BOTTOM),o.text(h.decay.text,h.decay.pos.x,h.decay.pos.y),o.text(h.sustain.text,h.sustain.pos.x,h.sustain.pos.y),o.textAlign(o.RIGHT,o.TOP),o.text(h.release.text,h.release.pos.x,h.release.pos.y);const p=s.amParams[r].harmonicity;o.textAlign(o.LEFT,o.BOTTOM),o.translate(p.pos.x,p.pos.y),o.rotate(Math.PI*-.5),o.text(p.text,0,0),o.pop(),o.pop()}),o.push(),o.textAlign(o.RIGHT,o.TOP),o.text(s.general.totalLength.text,s.general.totalLength.pos.x,s.general.totalLength.pos.y),o.pop(),X(o,i)},pt=n=>{const t=v.setSize("sketch");let e=B.setController();const s=st();let i,o,c,r,f,d,a;n.setup=async()=>{i=tt(s,t),o=q(r,s),c=D(i,o,s),r=L(o,e,s),d=V(i,o,c,s),a=await rt(o,s),n.createCanvas(t,t);const g=B.setGui(n,e,a.se,!0);ot(s,g),n.textSize(s.fontSize*t),n.textStyle(n.NORMAL),n.noLoop()},n.draw=()=>{if(a===void 0){n.noLoop();return}n.background(255),B.updateController(n,e),o=q(r,s,a),c=D(i,o,s,c),r=L(o,e,s,r),f=et(i,r,s,a.meter,f),d=V(i,o,c,s,d),ct(i,c,f,d,t,n)}};export{pt as sketch};
