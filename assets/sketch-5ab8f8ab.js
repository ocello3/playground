import{o as y,W as V,t as p,s as k,h as A,O as S,D as j,d as q,c as x}from"./tools-c504d83d.js";import{p as h}from"./index-0bdef767.js";import{F as D}from"./Freeverb-920a3fd4.js";import{E as _}from"./Effect-3276dc45.js";import"./CrossFade-799bb00a.js";import"./Split-1cec7d98.js";class f extends _{constructor(){super(y(f.getDefaults(),arguments,["distortion"])),this.name="Distortion";const n=y(f.getDefaults(),arguments,["distortion"]);this._shaper=new V({context:this.context,length:4096}),this._distortion=n.distortion,this.connectEffect(this._shaper),this.distortion=n.distortion,this.oversample=n.oversample}static getDefaults(){return Object.assign(_.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(n){this._distortion=n;const a=n*100,t=Math.PI/180;this._shaper.setMap(s=>Math.abs(s)<.001?0:(3+a)*s*20*t/(Math.PI+a*Math.abs(s)))}get oversample(){return this._shaper.oversample}set oversample(n){this._shaper.oversample=n}dispose(){return super.dispose(),this._shaper.dispose(),this}}const P=()=>({light:{speed:.005,shadowDistRate:100,lightDistRate:.25},boader:{speed:.001},object:{count:10,speed_min:.1,speed_max:1,lengthRate_min:.1,lengthRate_max:.5},shadow:{colorRate:.7,alpha:35},background:{shadowColor:240,shadowAlpha:220,lightColor:100,lightAlpha:255},synth:{volReducRate:.7,vol_min:-45,vol_max:-15,freq_min:280,freq_max:920}}),F=(e,n)=>{const a=n.pages[1],t=a.addFolder({title:"light"});t.addInput(e.light,"speed",{step:.001,min:.001,max:.1}),t.addInput(e.light,"shadowDistRate",{step:.1,min:1,max:1e3}),t.addInput(e.light,"lightDistRate",{step:.01,min:.01,max:2}),a.addFolder({title:"boader"}).addInput(e.boader,"speed",{min:1e-4,max:.01});const r=a.addFolder({title:"object"});r.addInput(e.object,"speed_min",{min:.01,max:1}),r.addInput(e.object,"speed_max",{min:.1,max:10}),r.addInput(e.object,"lengthRate_min",{min:.01,max:.3}),r.addInput(e.object,"lengthRate_max",{min:.3,max:1});const o=a.addFolder({title:"shadow"});o.addInput(e.shadow,"alpha",{step:1,min:10,max:250}),o.addInput(e.shadow,"colorRate",{step:.01,min:.1,max:1});const c=n.pages[2].addFolder({title:"synth"});c.addInput(e.synth,"volReducRate",{step:.1,min:.1,max:10}),c.addInput(e.synth,"vol_min",{step:1,min:-60,max:-30}),c.addInput(e.synth,"vol_max",{step:1,min:-30,max:-0}),c.addInput(e.synth,"freq_min",{step:1,min:30,max:500}),c.addInput(e.synth,"freq_max",{step:1,min:500,max:1500})},I=(e,n,a,t)=>{const s=t===void 0,r=(()=>{if(s)return Math.PI+e.angle;const l=t.angle+n.light.speed;return l>Math.PI*2?l-Math.PI*2:l})(),o=(()=>{const l=r<=e.angle,m=r>=Math.PI+e.angle;return l||m})(),d=s?!0:o!=t.isShadow,c=(()=>{const l=r/(Math.PI*2)-e.angle/(Math.PI*2),m=l<0?1+l:l;if(o){const w=m-.5;return p.map(Math.abs(w-.25),0,.25,1,0)}return p.map(Math.abs(m-.25),0,.25,1,0)})(),i=s?new h.Vector(a*.5,a*.5):t.start,u=(()=>{const l=m=>{const w=new h.Vector(0,0);return h.Vector.dist(i,w)*m};return d||s?l(o?n.light.shadowDistRate:n.light.lightDistRate):t.length})(),g=h.Vector.fromAngle(-1*r),v=h.Vector.add(i,h.Vector.mult(g,u));return{start:i,length:u,angle:r,angleRate:c,vec:g,end:v,isShadow:o,isSwitch:d}},R=(e,n,a)=>{const t=a===void 0,s=(()=>{if(t)return Math.PI;const g=a.angle-e.boader.speed;return g<0?Math.PI:g})(),r=h.Vector.fromAngle(s),o=n*Math.sqrt(2),d=new h.Vector(n*.5,n*.5),c=new h.Vector(o*.5*Math.cos(s),o*.5*Math.sin(s)),i=h.Vector.sub(d,c),u=h.Vector.add(d,c);return{vec:r,length:o,start:i,end:u,angle:s}},b=(e,n,a,t)=>{const s=t===void 0,r=(()=>s?Array.from(Array(n.object.count),()=>Math.random()):t.rates.map((l,m)=>t.isOvers[m]?Math.random():l))(),o=r.map(l=>p.map(l,0,1,n.object.speed_min,n.object.speed_max)),d=(()=>s?Array.from(Array(n.object.count),()=>Math.random()*e.length):t.intervals.map((l,m)=>t.isOvers[m]?0:l+o[m]))(),c=d.map(l=>h.Vector.add(e.start,h.Vector.mult(e.vec,l))),i=d.map(()=>h.Vector.fromAngle(e.angle+Math.PI*.5)),u=(()=>s?d.map(()=>Math.random()*a*.5):r.map(m=>p.map(m,0,1,n.object.lengthRate_max,n.object.lengthRate_min)).map(m=>a*m))(),g=c.map((l,m)=>h.Vector.add(l,h.Vector.mult(i[m],u[m]))),v=d.map(l=>l>e.length);return{rates:r,speeds:o,intervals:d,starts:c,vecs:i,lengths:u,ends:g,isOvers:v}},M=(e,n,a)=>{const t=a.starts,s=t.map((i,u)=>p.getIntersection(i,e.end,e.end,a.ends[u])),r=a.ends.map((i,u)=>p.getIntersection(i,s[u],n.start,n.end)),o=t.map((i,u)=>h.Vector.sub(s[u],i)),d=o.map(i=>h.Vector.normalize(i)),c=o.map(i=>h.Vector.mag(i));return{starts:t,ends:s,intersections:r,vecs:d,lengths:c}},C=(e,n,a,t,s)=>{const r=n.starts.map(c=>p.constrain(p.map(c.x,0,s,-1,1),-1,1)),o=n.rates.map(c=>p.map(e.isShadow?c/t.object.count:c*t.synth.volReducRate/t.object.count,0,1,t.synth.vol_min,t.synth.vol_max)),d=a.lengths.map(c=>p.constrain(p.map(c/s,0,72,t.synth.freq_min,t.synth.freq_max),t.synth.freq_min,t.synth.freq_max));return{pans:r,vols:o,freqs:d}},E=async e=>{const n=await k(),a=new D().toDestination();a.dampening=1e3,a.roomSize.value=.8,a.wet.value=.8;const t=new f().connect(a);t.distortion=.3,t.wet.value=.3;const s=Array.from(Array(e.object.count),()=>new A().connect(t)),r=s.map(o=>new S().connect(o).start());return j.mute=!0,{se:n,freeverb:a,dist:t,pans:s,oscs:r}},O=(e,n)=>{e.pans.forEach((a,t)=>a.pan.value=n.pans[t]),e.oscs.forEach((a,t)=>{a.frequency.value=n.freqs[t],a.volume.value=n.vols[t]})},$=(e,n,a,t,s,r,o)=>{e.isShadow&&o.background(s.background.shadowColor,s.background.shadowAlpha*e.angleRate),e.isShadow||o.background(s.background.lightColor,s.background.lightAlpha*e.angleRate),o.push(),o.stroke("black"),o.line(n.start.x,n.start.y,n.end.x,n.end.y),o.pop(),o.push(),o.stroke("black"),a.starts.forEach((d,c)=>{const i=a.ends[c];o.line(d.x,d.y,i.x,i.y)}),o.pop(),o.push(),o.noStroke(),t.starts.forEach((d,c)=>{const i=t.ends[c],u=t.intersections[c];o.fill(0,s.shadow.alpha*e.angleRate),o.triangle(d.x,d.y,i.x,i.y,a.ends[c].x,a.ends[c].y);const g=e.isShadow?0:s.background.shadowColor*s.shadow.colorRate;o.fill(g,s.background.shadowAlpha*e.angleRate),o.triangle(d.x,d.y,i.x,i.y,u.x,u.y)}),o.pop(),q(o,r)},K=e=>{const n=p.setSize("sketch");let a=x.setController();const t=P();let s,r,o,d,c,i;e.setup=async()=>{i=await E(t),r=R(t,n),s=I(r,t,n),o=b(r,t,n),d=M(s,r,o),e.createCanvas(n,n);const u=x.setGui(e,a,i.se,!1);F(t,u),e.noLoop()},e.draw=()=>{if(i===void 0){e.noLoop();return}x.updateController(e,a),r=R(t,n,r),s=I(r,t,n,s),o=b(r,t,n,o),d=M(s,r,o),$(s,r,o,d,t,n,e),c=C(s,o,d,t,n),O(i,c)}};export{K as sketch};
