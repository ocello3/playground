import{B as O,o as x,E as D,n as B,F as q,H as u,I as j,q as v,z as T,J as F,K as w,L as U,N,Q as W,R as G,t as z,U as V,s as H,V as J,d as K,c as A}from"./tools-c504d83d.js";import{d as Q}from"./debug-af332fa9.js";import{p as g}from"./index-0bdef767.js";import{A as X,M as Y}from"./Meter-b9e0509a.js";import"./Split-1cec7d98.js";class k extends O{constructor(){super(x(k.getDefaults(),arguments,["callback","value"])),this.name="ToneEvent",this._state=new D("stopped"),this._startOffset=0;const t=x(k.getDefaults(),arguments,["callback","value"]);this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(O.getDefaults(),{callback:B,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,s=>{let e;if(s.state==="started"){s.id!==-1&&this.context.transport.clear(s.id);const i=s.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||q(this._loop)&&this._loop>1){e=1/0,q(this._loop)&&(e=this._loop*this._getLoopDuration());const a=this._state.getAfter(i);a!==null&&(e=Math.min(e,a.time-i)),e!==1/0&&(this._state.setStateAtTime("stopped",i+e+1,{id:-1}),e=new u(this.context,e));const r=new u(this.context,this._getLoopDuration());s.id=this.context.transport.scheduleRepeat(this._tick.bind(this),r,new u(this.context,i),e)}else s.id=this.context.transport.schedule(this._tick.bind(this),new u(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const s=this.toTicks(t);return this._state.getValueAtTime(s)==="stopped"&&(this._state.add({id:-1,state:"started",time:s}),this._rescheduleEvents(s)),this}stop(t){this.cancel(t);const s=this.toTicks(t);if(this._state.getValueAtTime(s)==="started"){this._state.setStateAtTime("stopped",s,{id:-1});const e=this._state.getBefore(s);let i=s;e!==null&&(i=e.time),this._rescheduleEvents(i)}return this}cancel(t){t=v(t,-1/0);const s=this.toTicks(t);return this._state.forEachFrom(s,e=>{this.context.transport.clear(e.id)}),this._state.cancel(s),this}_tick(t){const s=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(s)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let e=.02;j(this.humanize)||(e=this.toSeconds(this.humanize)),t+=(Math.random()*2-1)*e}this.callback(t,this.value)}}_getLoopDuration(){return Math.round((this._loopEnd-this._loopStart)/this._playbackRate)}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new u(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new u(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,s=this._state.get(t);if(s!==null&&s.state==="started"){const e=this._getLoopDuration();return(t-s.time)%e/e}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class E extends k{constructor(){super(x(E.getDefaults(),arguments,["callback","events"])),this.name="Part",this._state=new D("stopped"),this._events=new Set;const t=x(E.getDefaults(),arguments,["callback","events"]);this._state.increasing=!0,t.events.forEach(s=>{T(s)?this.add(s[0],s[1]):this.add(s)})}static getDefaults(){return Object.assign(k.getDefaults(),{events:[]})}start(t,s){const e=this.toTicks(t);if(this._state.getValueAtTime(e)!=="started"){s=v(s,this._loop?this._loopStart:0),this._loop?s=v(s,this._loopStart):s=v(s,0);const i=this.toTicks(s);this._state.add({id:-1,offset:i,state:"started",time:e}),this._forEach(a=>{this._startNote(a,e,i)})}return this}_startNote(t,s,e){s-=e,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<e&&(s+=this._getLoopDuration()),t.start(new u(this.context,s))):t.startOffset<this._loopStart&&t.startOffset>=e&&(t.loop=!1,t.start(new u(this.context,s))):t.startOffset>=e&&t.start(new u(this.context,s))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(s=>{s.startOffset+=this._startOffset})}stop(t){const s=this.toTicks(t);return this._state.cancel(s),this._state.setStateAtTime("stopped",s),this._forEach(e=>{e.stop(t)}),this}at(t,s){const e=new F(this.context,t).toTicks(),i=new u(this.context,1).toSeconds(),a=this._events.values();let r=a.next();for(;!r.done;){const n=r.value;if(Math.abs(e-n.startOffset)<i)return w(s)&&(n.value=s),n;r=a.next()}return w(s)?(this.add(t,s),this.at(t)):null}add(t,s){t instanceof Object&&Reflect.has(t,"time")&&(s=t,t=s.time);const e=this.toTicks(t);let i;return s instanceof k?(i=s,i.callback=this._tick.bind(this)):i=new k({callback:this._tick.bind(this),context:this.context,value:s}),i.startOffset=e,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(t){this._state.forEach(s=>{s.state==="started"?this._startNote(t,s.time,s.offset):t.stop(new u(this.context,s.time))})}remove(t,s){return U(t)&&t.hasOwnProperty("time")&&(s=t,t=s.time),t=this.toTicks(t),this._events.forEach(e=>{e.startOffset===t&&(N(s)||w(s)&&e.value===s)&&(this._events.delete(e),e.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(s=>s.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(s=>{s instanceof E?s._forEach(t):t(s)}),this}_setAll(t,s){this._forEach(e=>{e[t]=s})}_tick(t,s){this.mute||this.callback(t,s)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(s=>{s.loopStart=this.loopStart,s.loopEnd=this.loopEnd,s.loop=t,this._testLoopBoundries(s)})}get loopEnd(){return new u(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopEnd=t,this._testLoopBoundries(s)})}get loopStart(){return new u(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopStart=this.loopStart,this._testLoopBoundries(s)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class I extends k{constructor(){super(x(I.getDefaults(),arguments,["callback","events","subdivision"])),this.name="Sequence",this._part=new E({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[];const t=x(I.getDefaults(),arguments,["callback","events","subdivision"]);this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(W(k.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,s){s!==null&&this.callback(t,s)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,s){return this._part.start(t,s&&this._indexTime(s)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new u(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(s,e)=>s[e],set:(s,e,i)=>(G(e)&&isFinite(parseInt(e,10))&&T(i)?s[e]=this._createSequence(i):s[e]=i,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,s,e){t.forEach((i,a)=>{const r=a*s+e;if(T(i))this._rescheduleSequence(i,s/i.length,r);else{const n=new u(this.context,r,"i").toSeconds();this._part.add(n,i)}})}_indexTime(t){return new u(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,t===0?this._part.loopEnd=this._indexTime(this._eventsArray.length):this._part.loopEnd=this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}const Z=(o,t,s)=>{if(!(s===void 0))return s;const i=t*o.hMargin,a=t*o.vMargin,r=i*2,n=a*(o.count+1),l=t-r,c=(t-n)/o.count,d=Array.from(Array(o.count),(p,_)=>{const f=i,h=a*(_+1)+c*_;return new g.Vector(f,h)}),b=d.map(()=>new g.Vector(l,c));return{coordinates:d,sizes:b}},R=(o,t)=>{const s=t===void 0,e=60/o.bpm,i=Array.from(Array(o.count),(l,c)=>`C${c}`),a=i.map((l,c)=>{const d=o.base.attack*Math.pow(o.mod.attack,c),b=o.base.decay*Math.pow(o.mod.decay,c),p=o.base.sustain*Math.pow(o.mod.sustain,c),_=o.base.release*Math.pow(o.mod.release,c),f=e/(d+b+_),h=f<1?f:1;return{attack:d*h,decay:b*h,sustain:p*h,release:_*h}}),r=o.currentSeqId===-1?0:o.currentSeqId,n=r+1>o.count-1?0:r+1;return s||t.am.envelope.set(a[n]),{seq:i,adsrs:a,adsrLength:e}},P=(o,t,s,e)=>{const i=e===void 0,a=o.sizes[0],r=a.x*s.hExpand,n=d=>d/t.adsrLength*r;return{envs:(i?Array.from(Array(s.count),()=>({startPos:new g.Vector(0,a.y),attackedPos:new g.Vector(0,0),decayedPos:new g.Vector(0,0),sustainedPos:new g.Vector(0,0),endPos:new g.Vector(r,a.y)})):e.envs).map((d,b)=>{const p={...d},_=t.adsrs[b],f={attack:n(_.attack),decay:n(_.decay),sustain:a.y*_.sustain,release:n(_.release)};return p.attackedPos.x=f.attack,p.decayedPos.x=p.attackedPos.x+f.decay,p.decayedPos.y=a.y-f.sustain,p.sustainedPos.x=r-f.release,p.sustainedPos.y=a.y-f.sustain,p})}},M=(o,t,s,e)=>{const i=e===void 0,a=s.currentSeqId===-1?0:s.currentSeqId,r=(()=>i?0:a!==e?.preSeqId?t.toneSec:e.timeStamp)(),n=t.toneSec-r,l=n/o.adsrLength;return{timeStamp:r,elapsedTime:n,progress:l,preSeqId:a}},tt=(o,t,s,e,i)=>{const a=i===void 0,r=s.currentSeqId===-1?0:s.currentSeqId,n=Array.from(Array(s.count),(h,y)=>y===r),l=a?o.sizes.map((h,y)=>{const S=o.sizes[y].x*s.rectWidth;return new g.Vector(S,h.y)}):i.rectSizes,c=a?n.map((h,y)=>{const S=Math.ceil(1/s.rectWidth);return Array.from(Array(S),(ct,C)=>{const L=l[y].x*C,$=0;return new g.Vector(L,$)})}):i.pointArrays,d=(()=>{const h=n.findIndex(m=>m===!0),y=o.sizes[h].x*t.progress,S=c[h].findIndex(m=>m.x<y&&y<m.x+l[h].x);return{arrayIndex:h,rectIndex:S}})(),b=a?!1:r===0&&i.preSeqId===s.count-1,p=z.constrain(z.map(e.getValue(),-200,0,0,255),0,255),_=a||b?c.map(h=>h.map(()=>0)):i.alphaArrays.map((h,y)=>n[y]?h.map((S,m)=>i.currentRectId.rectIndex<m&&m<=d.rectIndex?p:S):h);return{isDraws:n,pointArrays:c,currentRectId:d,alphaArrays:_,rectSizes:l,preSeqId:r}},st=()=>({count:4,hMargin:.06,vMargin:.04,hExpand:1,rectWidth:.01,bpm:32,currentSeqId:-1,pitch:"B4",base:{attack:.4,decay:.2,sustain:.6,release:.7},mod:{attack:.5,decay:.5,sustain:.5,release:.5},currentAdsr:{attack:.2,decay:.1,sustain:.3,release:.3},isAdsrUpdate:!1}),et=(o,t)=>{t.pages[1].addInput(o,"hExpand",{step:1,min:1,max:10});const e=t.pages[2];e.addInput(o,"bpm",{step:1,min:20,max:200}).on("change",i=>V.bpm.value=i.value/2),e.addInput(o.base,"attack",{label:"base_a",step:.01,min:.01,max:1}),e.addInput(o.base,"decay",{label:"base_d",step:.01,min:.01,max:1}),e.addInput(o.base,"sustain",{label:"base_s",step:.01,min:.01,max:1}),e.addInput(o.base,"release",{label:"base_r",step:.01,min:.01,max:1}),e.addInput(o.mod,"attack",{label:"mod_a",step:.1,min:.1,max:2}),e.addInput(o.mod,"decay",{label:"mod_d",step:.1,min:.1,max:2}),e.addInput(o.mod,"sustain",{label:"mod_s",step:.1,min:.1,max:2}),e.addInput(o.mod,"release",{label:"mod_r",step:.1,min:.1,max:2})},it=()=>{const o=new X;return o.toDestination(),o},ot=o=>{const t=new Y;return o.connect(t),t},at=(o,t,s)=>{const e=new I((i,a)=>{J.schedule(()=>{const n=s.currentSeqId+1,l=n>s.count-1||s.currentSeqId<0?0:n;s.currentSeqId=l,console.log(`note: ${a}, index: ${s.currentSeqId}, actualAttack: ${o.get().envelope.attack}`)},i),o.triggerAttackRelease("C5",.1,i),o.envelope.set(s.currentAdsr)},t.seq);return e.loop=!0,V.bpm.value=s.bpm/2,e.start(0),e},nt=async(o,t)=>{const s=await H(),e=it(),i=ot(e),a=at(e,o,t);return{se:s,am:e,meter:i,toneSeq:a}},rt=(o,t,s,e,i)=>{o.coordinates.forEach((a,r)=>{i.push(),i.translate(a.x,a.y),i.stroke(1),i.push(),i.noFill(),i.beginShape();const n=t.envs[r];i.vertex(n.startPos.x,n.startPos.y),i.vertex(n.attackedPos.x,n.attackedPos.y),i.vertex(n.decayedPos.x,n.decayedPos.y),i.vertex(n.sustainedPos.x,n.sustainedPos.y),i.vertex(n.endPos.x,n.endPos.y),i.endShape(),i.pop(),i.push(),i.noStroke();const l=s.pointArrays[r],c=s.alphaArrays[r];l.forEach((d,b)=>{i.push(),i.fill(0,c[b]),i.rect(d.x,d.y,s.rectSizes[r].x,s.rectSizes[r].y),i.pop()}),i.pop(),i.pop()}),K(i,e)},_t=o=>{const t=z.setSize("sketch");let s=A.setController();const e=st();let i,a,r,n,l,c;o.setup=async()=>{i=Z(e,t),a=R(e),r=P(i,a,e),n=M(a,s,e),c=await nt(a,e),o.createCanvas(t,t);const d=A.setGui(o,s,c.se,!0);et(e,d),o.noLoop()},o.draw=()=>{if(c===void 0){o.noLoop();return}o.frameCount%5===0&&Q({currentSeqId:e.currentSeqId},10),o.background(255),A.updateController(o,s),a=R(e,c),r=P(i,a,e,r),n=M(a,s,e,n),l=tt(i,n,e,c.meter,l),rt(i,r,l,t,o)}};export{_t as sketch};
