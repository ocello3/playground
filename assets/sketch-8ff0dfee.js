import{s as $,h as G,t as w,k as Y,c as d,d as A}from"./tools-365e5452.js";import{d as N}from"./debug-7c7a59b5.js";import{G as O}from"./GrainPlayer-0352325a.js";import{A as U,M as W}from"./Meter-4a5975ce.js";import{p as b}from"./index-f74d983d.js";import"./Split-979b2e75.js";const _=()=>{const t=["right","right","left","left"],l=.5/t.length;return{marginRate:.2,loopRangeLineYPosRate:1.1,alignments:t,boxIntervalRate:.01,boxHeightRate:l,easingFMin:.05,easingFMax:.5,playbackRateMin:.3,playbackRateMax:3.5,loopRetentionFrameRateMin:.3,loopRetentionFrameRateMax:2.5,amSynthVolumeMin:-40,amSynthVolumeMax:-10,amSynthNote:["G6","D7","C7","E7"],granularVolumeMin:-15,granularVolumeMax:-3,hues:[357,237],saturations:[68,68],brightnesses:[80,80],saturationRange:15,brightnessRange:65,ampRateMin:.1,ampRateMax:.9,waveLengthRateMin:.01,waveLengthRateMax:1,waveSpeedRateMin:1e-5,waveSpeedRateMax:1e-4}};_();const I=(t,o)=>{o.pages[1].addBinding(t,"marginRate",{step:.1,min:.1,max:1})},J="/playground/assets/track_1-043a5dc7.mp3",Q="/playground/assets/track_2-ea523552.mp3",P=async t=>{const o=new Y;return await o.load(t),o},v=t=>t.duration,j=(t,o,l)=>{const r=new O(t).connect(l);return r.volume.value=-5,r.loop=!0,r.loopStart=0,r.grainSize=o,r},q=t=>{const o=new U;return o.connect(t),o},z=async()=>{const t=await $(),o=[await P(J),await P(Q)],l=[v(o[0]),v(o[1]),v(o[0]),v(o[1])],r=l.map(()=>new G().toDestination());r.forEach((i,e)=>{i.set({pan:w.map(e,0,l.length,-1,1)})});const n=l.map((i,e)=>j(o[e%2],i,r[e])),h=l.map((i,e)=>q(r[e]));return{se:t,panners:r,players:n,amSynths:h,data:{durations:l}}};await z();const K=(t,o,l,r,n)=>{n==2&&t.players.forEach(h=>h.start()),o.loopRetentionFrames.forEach((h,i)=>{t.players[i].volume.value=l.amplitudes[i],h===0&&(t.panners[i].pan.value=l.panValues[i],t.players[i].reverse=o.loopIsReverses[i],t.players[i].loopStart=o.loopStartTimes[i],t.players[i].grainSize=o.loopGrainSizes[i],t.players[i].playbackRate=o.playbackRates[i])}),o.loopIsSwitches.forEach((h,i)=>{if(h===!0){const e=w.map(o.playbackRates[i],r.playbackRateMin,r.playbackRateMax,r.amSynthVolumeMin,r.amSynthVolumeMax);t.amSynths[i].volume.value=e,t.amSynths[i].triggerAttackRelease(r.amSynthNote[i],"16n")}})},X=t=>{const o=t.data.durations,l=o.map(()=>new W);return t.players.forEach((r,n)=>r.connect(l[n])),{durations:o,volumes:l}},L=(t,o,l,r,n)=>{const h=n.currentHeights.map(e=>{const f=w.map(e,0,r.size.y,t.granularVolumeMin,t.granularVolumeMax),s=w.constrain(f,t.granularVolumeMin,t.granularVolumeMax);return isNaN(s)?0:s}),i=l.currentPositions.map(e=>w.map(e.x,0,o,-1,1));return{amplitudes:h,panValues:i}},V=(t,o,l,r)=>{const n=r===void 0,h=t.durations.reduce((R,m)=>m>R?m:R,0),i=t.durations.map((R,m)=>{if(n||r.loopRetentionFrames[m]===0){const S=w.map(Math.random(),0,1,o.loopRetentionFrameRateMin,o.loopRetentionFrameRateMax);return R*60*Math.floor(S)}return r.loopRetentionFrames[m]-1}),e=i.map(R=>R===0),f=e.map((R,m)=>n||R?w.map(Math.random(),0,1,o.playbackRateMin,o.playbackRateMax):r.playbackRates[m]),s=t.durations.map((R,m)=>n||e[m]?Math.random()*R:r.loopStartTimes[m]),g=t.durations.map((R,m)=>n||e[m]?Math.random()*R:r.loopEndTimes[m]),c=e.map((R,m)=>n?!1:R?s[m]>g[m]:r.loopIsReverses[m]),a=e.map((R,m)=>{if(n||R||r.loopIsOvers[m])return 0;const S=r.loopStampTimes[m];return l*.001-S}),p=a.map((R,m)=>R>t.durations[m]/f[m]),u=p.map((R,m)=>n||R||e[m]?l*.001:r.loopStampTimes[m]),y=a.map((R,m)=>R/t.durations[m]*f[m]),M=g.map((R,m)=>Math.abs(R-s[m]));return{longestDuration:h,loopRetentionFrames:i,loopIsSwitches:e,playbackRates:f,loopStartTimes:s,loopEndTimes:g,loopIsReverses:c,loopElapsedTimes:a,loopIsOvers:p,loopStampTimes:u,loopProgressRates:y,loopGrainSizes:M}},E=(t,o,l,r,n)=>{const h=n===void 0,i=(()=>h?l*(1-o.marginRate)/t.longestDuration:n.bufferConvertRateToLength)(),e=(()=>h?r.durations.map(c=>c*i):n.fullLengths)(),f=(()=>h?o.alignments.map((c,a)=>{const p=l*o.marginRate*.5,u=c==="right"?p:l-e[a]-p,M=l*o.boxHeightRate*o.alignments.length,R=l-M,m=o.alignments.length+1,S=R/m;return new b.Vector(u,S)}):n.margins)(),s=(()=>h?r.durations.map((c,a)=>{const p=f[a].x,u=l*o.boxHeightRate,y=f[a].y*(a+1)+u*a;return new b.Vector(p,y)}):n.startPositions)(),g=(()=>h?s.map((c,a)=>b.Vector.add(c,new b.Vector(e[a],0))):n.endPositions)();return{bufferConvertRateToLength:i,fullLengths:e,margins:f,startPositions:s,endPositions:g}},F=(t,o,l,r,n,h)=>{const i=h===void 0,e=(()=>i?n.startPositions:h.startPositions.map((p,u)=>{if(!l.loopIsSwitches[u])return p;const y=p.copy(),M=l.loopStartTimes[u]/r.durations[u],m=n.fullLengths[u]*M+n.margins[u].x;return y.x=m,y}))(),f=(()=>i?e:h.startCurrentPositions.map((p,u)=>{const y=e[u],M=y.x-p.x;if(Math.abs(M)<1)return y;const R=w.map(l.playbackRates[u],t.playbackRateMin,t.playbackRateMax,t.easingFMin,t.easingFMax),m=new b.Vector(M*R,0);return b.Vector.add(p,m)}))(),s=(()=>i?n.endPositions:h.endPositions.map((p,u)=>{if(!l.loopIsSwitches[u])return p;const y=p.copy(),M=l.loopEndTimes[u]/r.durations[u],m=n.fullLengths[u]*M+n.margins[u].x;return y.x=m,y}))(),g=(()=>i?s:h.endCurrentPositions.map((p,u)=>{const y=s[u],M=y.x-p.x;if(Math.abs(M)<1)return y;const R=w.map(l.playbackRates[u],t.playbackRateMin,t.playbackRateMax,t.easingFMin,t.easingFMax),m=new b.Vector(M*R,0);return b.Vector.add(p,m)}))(),c=e.map((p,u)=>i?0:Math.abs(s[u].x-p.x)*l.loopProgressRates[u]),a=(()=>i?r.durations.map((p,u)=>{const y=n.margins[u].x,M=o/(r.durations.length+1)*(u+1);return new b.Vector(y,M)}):h.currentPositions.map((p,u)=>l.loopIsReverses[u]?(p.x=e[u].x-c[u],p):(p.x=e[u].x+c[u],p)))();return{startPositions:e,startCurrentPositions:f,endPositions:s,endCurrentPositions:g,progresses:c,currentPositions:a}},T=(t,o,l,r,n)=>{const h=n===void 0,i=new b.Vector(o*t.boxIntervalRate,o*t.boxHeightRate),e=r.startPositions.map((c,a)=>{if(h||l.loopIsSwitches[a]){const p=c.x-r.endPositions[a].x,u=Math.ceil(Math.abs(p/i.x));return u<1?1:u}return n.counts[a]}),f=r.startPositions.map((c,a)=>h||l.loopIsSwitches[a]?Array.from(Array(e[a]),(p,u)=>{const y=l.loopIsReverses[a]?-1:1,M=new b.Vector(i.x*y*u,0);return b.Vector.add(c,M)}):n.positionArrays[a]),s=r.progresses.map((c,a)=>{if(h||l.loopIsSwitches[a]||l.loopIsOvers[a])return 0;const p=i.x*n.currentIndexes[a],u=Math.abs(c-p),y=Math.floor(u/i.x),M=n.currentIndexes[a]+y,R=f[a].length-1;return M>R?R:M}),g=s.map((c,a)=>h?0:c-n.currentIndexes[a]);return{size:i,counts:e,positionArrays:f,currentIndexes:s,addedSegments:g}},C=(t,o,l,r,n,h)=>{const i=h===void 0,e=t.loopIsSwitches.map((c,a)=>i||c?w.map(Math.random(),0,1,o.waveSpeedRateMin*l,o.waveSpeedRateMax*l):h.angleSpeeds[a]),f=n.positionArrays.map((c,a)=>{if(i||t.loopIsSwitches[a]){const p=Math.abs(r.endPositions[a].x-r.startPositions[a].x),u=w.map(Math.random(),0,1,o.waveLengthRateMin,o.waveLengthRateMax),y=p*u,M=p/y,m=Math.PI*2*M/n.counts[a];return c.map((S,x)=>m*x)}return h.angleArrays[a].map(p=>p+e[a])}),s=t.loopIsSwitches.map((c,a)=>i||c?w.map(Math.random(),0,1,o.ampRateMin*n.size.y,o.ampRateMax*n.size.y):h.amps[a]),g=n.positionArrays.map((c,a)=>{const p=s[a];return c.map((u,y)=>{const M=f[a][y],R=u.y+n.size.y*.5,m=w.map(Math.sin(M),-1,1,-.5,.5)*p;return new b.Vector(u.x,R+m)})});return{angleSpeeds:e,angleArrays:f,amps:s,positionArrays:g}},H=(t,o,l)=>{const r=l===void 0,n=(()=>{const f=new b.Vector(0,t.size.y);return t.positionArrays.map((s,g)=>s.filter((a,p)=>p<=t.currentIndexes[g]).map(a=>b.Vector.add(a,f)))})(),h=o.positionArrays.map((f,s)=>{const g=t.currentIndexes[s],c=f[g];return n[s][g].y-c.y}),i=n.map((f,s)=>{const g=h[s],c=t.addedSegments[s],a=f.length;if(r||c<0)return Array.from(Array(a),()=>g);const p=l.heightArrays[s];if(c===0)return p.map((y,M)=>M===p.length-1?g:y);const u=Array.from(Array(c),()=>g);return p.concat(u)}),e=n.map((f,s)=>f.map((g,c)=>{const a=new b.Vector(0,i[s][c]);return b.Vector.sub(g,a)}));return{LLpositionArrays:n,currentHeights:h,heightArrays:i,positionArrays:e}},B=(t,o,l,r,n)=>{const h=t.loopIsReverses.map(s=>{const g=s?0:1;return o.hues[g]}),i=t.loopIsReverses.map((s,g)=>{const c=s?1:0,a=o.saturations[c];return w.map(t.playbackRates[g],o.playbackRateMin,o.playbackRateMax,a-o.saturationRange,a+o.saturationRange)}),e=t.loopIsReverses.map(s=>{const g=s?1:0;return o.brightnesses[g]}),f=r.positionArrays.map((s,g)=>{const c=l.volumes[g].getValue(),a=isFinite(c)?c:0,p=w.map(a,-50,-20,e[g]-o.brightnessRange,e[g]+o.brightnessRange),u=w.constrain(p,e[g]-o.brightnessRange,e[g]+o.brightnessRange);if(n===void 0||t.loopIsOvers[g]||t.loopIsSwitches[g])return s.map(()=>u);const y=n.brightnessArrays[g],M=s.length-y.length;if(M===0)return y[y.length-1]=u,y;const R=Array.from(Array(M),()=>u);return y.concat(R)});return{hues:h,saturations:i,brightnesses:e,brightnessArrays:f}},Z=(t,o,l,r,n,h,i,e)=>{e.push(),e.noFill(),e.strokeWeight(1),e.strokeCap(e.SQUARE),t.startPositions.forEach((f,s)=>{e.stroke(n.hues[s],n.saturations[s],n.brightnesses[s]),e.line(f.x,f.y+h.size.y*i.loopRangeLineYPosRate,t.endPositions[s].x,t.endPositions[s].y+h.size.y*i.loopRangeLineYPosRate)}),e.strokeWeight(3),e.strokeCap(e.PROJECT),o.startCurrentPositions.forEach((f,s)=>{e.push(),e.stroke(n.hues[s],n.saturations[s],n.brightnesses[s]),e.line(f.x,f.y+h.size.y*i.loopRangeLineYPosRate,o.endCurrentPositions[s].x,o.endCurrentPositions[s].y+h.size.y*i.loopRangeLineYPosRate),e.pop()}),e.pop(),e.push(),l.positionArrays.forEach((f,s)=>{const g=h.currentIndexes[s];e.stroke(n.hues[s],n.saturations[s],n.brightnesses[s]),f.forEach((c,a)=>{a>g&&e.line(c.x,c.y,c.x+h.size.x,c.y)})}),e.pop(),e.push(),e.noStroke(),r.positionArrays.forEach((f,s)=>{const g=n.hues[s],c=n.brightnessArrays[s],a=n.saturations[s],p=r.heightArrays[s];f.forEach((u,y)=>{const M=p[y],R=c[y];e.fill(g,R,a),e.rect(u.x,u.y,h.size.x,M)})}),e.pop()},st=t=>{const o=w.setSize("sketch");let l=d.setController();const r=_();let n,h,i,e,f,s,g,c,a,p;t.setup=async()=>{h=await z(),i=X(h),n=V(i,r,t.millis()),f=E(n,r,o,i),s=F(r,o,n,i,f),g=T(r,o,n,s),c=C(n,r,o,s,g),a=H(g,c),p=B(n,r,i,g,p),e=L(r,o,s,g,a),t.createCanvas(o,o);const u=d.setGui(t,l,h.se,!1);I(r,u),t.colorMode(t.HSB),t.noLoop(),A(t,o)},t.draw=()=>{if(h===void 0){t.noLoop();return}t.frameCount%5===0&&N({na:"working"},10),t.background(255),d.updateController(t,l),n=V(i,r,t.millis(),n),f=E(n,r,o,i,f),s=F(r,o,n,i,f,s),g=T(r,o,n,s,g),c=C(n,r,o,s,g,c),a=H(g,c,a),p=B(n,r,i,g,p),e=L(r,o,s,g,a),Z(f,s,c,a,p,g,r,t),A(t,o),K(h,n,e,r,t.frameCount)}};export{st as sketch};
