import{s as T,D as V,K as $,d as E,t as A,c as _}from"./tools-b05efc32.js";import{d as C}from"./debug-65265d6f.js";import{p as u}from"./index-85fd13a2.js";const R=t=>{const a=t===void 0,n=(()=>{if(a)return"init";if(t.status==="init")return"waiting";if(t.status==="waiting")return t.elapsedTime>t.duration.waiting?"attack_1":"waiting";if(t.status==="attack_1")return t.rate>t.targetRate.max?"sustain_1":"attack_1";if(t.status==="sustain_1")return t.elapsedTime>t.duration.sustain_1?"attack_2":"sustain_1";if(t.status==="attack_2")return t.rate<t.targetRate.min?"sustain_2":"attack_2";if(t.status==="sustain_2")return t.elapsedTime>t.duration.sustain_2?"release":"sustain_2";if(t.status==="release")return t.rate>t.targetRate.base?"init":"release";throw`preRate: ${t.rate}, preElapsedTime: ${t.elapsedTime}`})(),e=a||n==="init"?{waiting:20,sustain_1:2,sustain_2:30}:t.duration,s=a||n==="init"?{min:.1,max:1,base:.333}:t.targetRate,i=a||n==="init"?{attack_1:.1,attack_2:.2,release:.03}:t.coefficient,r=(()=>a||n!==t.status?0:t.elapsedTime+1)(),l=(()=>{if(a||n==="init")return s.base;if(n==="waiting")return t.rate;if(n==="attack_1")return t.rate+t.coefficient.attack_1;if(n==="sustain_1")return t.rate;if(n==="attack_2")return t.rate-t.coefficient.attack_2;if(n==="sustain_2")return t.rate;if(n==="release")return t.rate+t.coefficient.release;throw`status: ${n}`})();return{status:n,duration:e,targetRate:s,coefficient:i,elapsedTime:r,rate:l}},b=(t,a)=>{const n=a===void 0,e=(()=>{if(n)return"init";if(a.status==="init")return"waiting";if(a.status==="waiting")return t==="waiting"||t==="attack_1"||t==="sustain_1"||t==="sustain_2"?"waiting":"attack";if(a.status==="attack")return a.rate<a.targetRate.max?"attack":"release";if(a.status==="release")return t==="init"?"init":"release";throw`status_1: ${t}`})(),s=n||e==="init"?{max:1,base:.5}:a.targetRate,i=n||e==="init"?{attack:.04,release:.04}:a.coefficient,r=(()=>{if(n||e==="init")return s.base;if(e==="waiting")return a.rate;if(e==="attack")return a.rate+i.attack;if(e==="release")return a.rate<a.targetRate.base?a.rate:a.rate-i.release;throw`status: ${e}`})();return{status:e,targetRate:s,coefficient:i,rate:r}},x=(t,a,n,e,s)=>{const i=s===void 0,r=i?new u.Vector(t%2*n*.5,Math.floor(t/2)*n*.5):s.compartmentOrigin,l=.5,w=i?[...a.font.str].map((c,o)=>new u.Vector(n*a.font.baseScaleRates[o],n*a.font.baseScaleRates[o])):s.baseScales,f=i?R():R(s.rate_1vs2and3),m=i?b(f.status):b(f.status,s.rate_2vs3),k=(()=>{const c=1-f.rate,o=[f.rate,c*m.rate,c*(1-m.rate)];return w.map((g,d)=>u.Vector.mult(g,[o[d],1]))})(),h=[...a.font.str].map((c,o)=>e.textWidth(c)*k[o].x),S=h.map((c,o,g)=>g.slice(0,o).reduce((d,y)=>u.Vector.add(d,new u.Vector(y,0)),new u.Vector(0,n*.5)));return{compartmentOrigin:r,compartmentScale:l,textWidths:h,baseScales:w,rate_1vs2and3:f,rate_2vs3:m,scales:k,poses:S}},v=(t,a,n,e)=>e===void 0?Array.from(Array(t.font.count),(i,r)=>x(r,t,a,n)):e.map((i,r)=>x(r,t,a,n,i)),I=()=>({font:{count:4,str:"バタン",baseScaleRates:[.08,.04,.05]},maxVolume:-10}),O=(t,a)=>{a.pages[2].addInput(t,"maxVolume",{step:1,min:-60,max:0})},F=async()=>{const t=await T();return console.log(V.get()),{se:t}},L=(t,a,n,e)=>{e.push(),e.fill(0),t.forEach(s=>{e.push(),e.translate(s.compartmentOrigin.x,s.compartmentOrigin.y),e.scale(s.compartmentScale),$(s.poses)&&s.poses.forEach((i,r)=>{e.push(),e.translate(i.x,i.y),e.scale(s.scales[r].x,s.scales[r].y),e.text(a.font.str.charAt(r),0,0),e.pop()}),e.pop()}),e.pop(),E(e,n)},K=t=>{const a=A.setSize("sketch");let n=_.setController();const e=I();let s,i;t.setup=async()=>{i=await F(),s=v(e,a,t),t.createCanvas(a,a);const r=_.setGui(t,n,i.se,!1);O(e,r),t.textAlign(t.LEFT,t.CENTER),t.noLoop()},t.draw=()=>{if(i===void 0){t.noLoop();return}t.frameCount%5===0&&C({debug:!1},10),t.background(255),_.updateController(t,n),s=v(e,a,t,s),L(s,e,a,t)}};export{K as sketch};
