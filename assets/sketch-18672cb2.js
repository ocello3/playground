import{F as T,o as _,H as z,q as D,I as w,J as c,K as q,v as g,E,L,N as y,Q as M,R as V,U as C,V as F,s as j,X as B,d as $,t as N,c as S}from"./tools-380870f1.js";import{d as U}from"./debug-a9561137.js";import{p as d}from"./index-80725c7a.js";import{A as G}from"./AMSynth-565cb4c3.js";class u extends T{constructor(){super(_(u.getDefaults(),arguments,["callback","value"])),this.name="ToneEvent",this._state=new z("stopped"),this._startOffset=0;const t=_(u.getDefaults(),arguments,["callback","value"]);this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(T.getDefaults(),{callback:D,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,s=>{let e;if(s.state==="started"){s.id!==-1&&this.context.transport.clear(s.id);const i=s.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||w(this._loop)&&this._loop>1){e=1/0,w(this._loop)&&(e=this._loop*this._getLoopDuration());const a=this._state.getAfter(i);a!==null&&(e=Math.min(e,a.time-i)),e!==1/0&&(this._state.setStateAtTime("stopped",i+e+1,{id:-1}),e=new c(this.context,e));const n=new c(this.context,this._getLoopDuration());s.id=this.context.transport.scheduleRepeat(this._tick.bind(this),n,new c(this.context,i),e)}else s.id=this.context.transport.schedule(this._tick.bind(this),new c(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const s=this.toTicks(t);return this._state.getValueAtTime(s)==="stopped"&&(this._state.add({id:-1,state:"started",time:s}),this._rescheduleEvents(s)),this}stop(t){this.cancel(t);const s=this.toTicks(t);if(this._state.getValueAtTime(s)==="started"){this._state.setStateAtTime("stopped",s,{id:-1});const e=this._state.getBefore(s);let i=s;e!==null&&(i=e.time),this._rescheduleEvents(i)}return this}cancel(t){t=g(t,-1/0);const s=this.toTicks(t);return this._state.forEachFrom(s,e=>{this.context.transport.clear(e.id)}),this._state.cancel(s),this}_tick(t){const s=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(s)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let e=.02;q(this.humanize)||(e=this.toSeconds(this.humanize)),t+=(Math.random()*2-1)*e}this.callback(t,this.value)}}_getLoopDuration(){return Math.round((this._loopEnd-this._loopStart)/this._playbackRate)}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new c(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new c(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,s=this._state.get(t);if(s!==null&&s.state==="started"){const e=this._getLoopDuration();return(t-s.time)%e/e}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class f extends u{constructor(){super(_(f.getDefaults(),arguments,["callback","events"])),this.name="Part",this._state=new z("stopped"),this._events=new Set;const t=_(f.getDefaults(),arguments,["callback","events"]);this._state.increasing=!0,t.events.forEach(s=>{E(s)?this.add(s[0],s[1]):this.add(s)})}static getDefaults(){return Object.assign(u.getDefaults(),{events:[]})}start(t,s){const e=this.toTicks(t);if(this._state.getValueAtTime(e)!=="started"){s=g(s,this._loop?this._loopStart:0),this._loop?s=g(s,this._loopStart):s=g(s,0);const i=this.toTicks(s);this._state.add({id:-1,offset:i,state:"started",time:e}),this._forEach(a=>{this._startNote(a,e,i)})}return this}_startNote(t,s,e){s-=e,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<e&&(s+=this._getLoopDuration()),t.start(new c(this.context,s))):t.startOffset<this._loopStart&&t.startOffset>=e&&(t.loop=!1,t.start(new c(this.context,s))):t.startOffset>=e&&t.start(new c(this.context,s))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(s=>{s.startOffset+=this._startOffset})}stop(t){const s=this.toTicks(t);return this._state.cancel(s),this._state.setStateAtTime("stopped",s),this._forEach(e=>{e.stop(t)}),this}at(t,s){const e=new L(this.context,t).toTicks(),i=new c(this.context,1).toSeconds(),a=this._events.values();let n=a.next();for(;!n.done;){const r=n.value;if(Math.abs(e-r.startOffset)<i)return y(s)&&(r.value=s),r;n=a.next()}return y(s)?(this.add(t,s),this.at(t)):null}add(t,s){t instanceof Object&&Reflect.has(t,"time")&&(s=t,t=s.time);const e=this.toTicks(t);let i;return s instanceof u?(i=s,i.callback=this._tick.bind(this)):i=new u({callback:this._tick.bind(this),context:this.context,value:s}),i.startOffset=e,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(t){this._state.forEach(s=>{s.state==="started"?this._startNote(t,s.time,s.offset):t.stop(new c(this.context,s.time))})}remove(t,s){return M(t)&&t.hasOwnProperty("time")&&(s=t,t=s.time),t=this.toTicks(t),this._events.forEach(e=>{e.startOffset===t&&(V(s)||y(s)&&e.value===s)&&(this._events.delete(e),e.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(s=>s.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(s=>{s instanceof f?s._forEach(t):t(s)}),this}_setAll(t,s){this._forEach(e=>{e[t]=s})}_tick(t,s){this.mute||this.callback(t,s)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(s=>{s.loopStart=this.loopStart,s.loopEnd=this.loopEnd,s.loop=t,this._testLoopBoundries(s)})}get loopEnd(){return new c(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopEnd=t,this._testLoopBoundries(s)})}get loopStart(){return new c(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopStart=this.loopStart,this._testLoopBoundries(s)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class k extends u{constructor(){super(_(k.getDefaults(),arguments,["callback","events","subdivision"])),this.name="Sequence",this._part=new f({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[];const t=_(k.getDefaults(),arguments,["callback","events","subdivision"]);this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(C(u.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,s){s!==null&&this.callback(t,s)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,s){return this._part.start(t,s&&this._indexTime(s)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new c(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(s,e)=>s[e],set:(s,e,i)=>(F(e)&&isFinite(parseInt(e,10))&&E(i)?s[e]=this._createSequence(i):s[e]=i,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,s,e){t.forEach((i,a)=>{const n=a*s+e;if(E(i))this._rescheduleSequence(i,s/i.length,n);else{const r=new c(this.context,n,"i").toSeconds();this._part.add(r,i)}})}_indexTime(t){return new c(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,t===0?this._part.loopEnd=this._indexTime(this._eventsArray.length):this._part.loopEnd=this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}const H=(o,t,s)=>{if(!(s===void 0))return s;const i=t*o.hMargin,a=t*o.vMargin,n=i*2,r=a*(o.count+1),h=t-n,l=(t-r)/o.count,p=Array.from(Array(o.count),(x,b)=>{const R=i,I=a*(b+1)+l*b;return new d.Vector(R,I)}),m=p.map(()=>new d.Vector(h,l));return{coordinates:p,sizes:m}},O=o=>{const t=60/o.bpm,s=Array.from(Array(o.count),(i,a)=>`C${a}`),e=s.map((i,a)=>{const n=o.adsr.attack*Math.pow(.3,a),r=o.adsr.decay,h=o.adsr.sustain,l=t-(n+r);return{attack:n,decay:r,sustain:h,release:l}});return{seq:s,adsrs:e,adsrLength:t}},v=(o,t,s)=>{const e=o.sizes[0],i=e.x*s.hExpand;return{envs:Array.from(Array(s.count),(n,r)=>{const h=t.adsrs[r],l=new d.Vector(0,e.y),p=new d.Vector(h.attack/t.adsrLength*i,0),m=new d.Vector(p.x+h.decay/t.adsrLength*i,e.y-e.y*h.sustain),x=new d.Vector(i-h.release/t.adsrLength,e.y),b=new d.Vector(i,e.y);return{points:[l,p,m,x,b]}})}},A=(o,t,s,e)=>{const i=e===void 0,a=(()=>i?0:s.currentSeqId!==e?.preSeqId?t.toneSec:e.timeStamp)(),n=t.toneSec-a,r=n/o.adsrLength,h=s.currentSeqId;return{timeStamp:a,elapsedTime:n,progress:r,preSeqId:h}},J=(o,t,s)=>{const e=Array.from(Array(s.count),(n,r)=>r===s.currentSeqId),i=e.map((n,r)=>{const l=n?o.sizes[r].x*t.progress:0,p=0;return new d.Vector(l,p)}),a=o.sizes.map(n=>n.y);return{isDraws:e,points:i,lengths:a}},K=()=>({count:3,hMargin:.06,vMargin:.04,hExpand:1,bpm:60,currentSeqId:0,pitch:"B5",adsr:{attack:.4,decay:.2,sustain:.5}}),P=(o,t)=>{t.pages[1].addInput(o,"hExpand",{step:1,min:1,max:10});const e=t.pages[2];e.addInput(o.adsr,"attack",{step:.01,min:.01,max:1}),e.addInput(o.adsr,"decay",{step:.01,min:.01,max:1}),e.addInput(o.adsr,"sustain",{step:.01,min:.01,max:1})},Q=()=>{const o=new G;return o.toDestination(),o},W=(o,t,s)=>{const e=new k((i,a)=>{s.currentSeqId=t.seq.indexOf(a),o.envelope.set(t.adsrs[s.currentSeqId]),o.triggerAttackRelease("C5",.1,i)},t.seq);return e.loop=!0,B.bpm.value=s.bpm/2,e.start(0),e},X=async(o,t)=>{const s=await j(),e=Q(),i=W(e,o,t);return{se:s,am:e,toneSeq:i}},Y=(o,t,s,e,i)=>{o.coordinates.forEach((a,n)=>{i.push(),i.translate(a.x,a.y),i.stroke(1),i.push(),i.noFill();const r=o.sizes[n];if(i.rect(0,0,r.x,r.y),i.pop(),i.push(),i.noFill(),i.beginShape(),t.envs[n].points.forEach(h=>i.vertex(h.x,h.y)),i.endShape(),i.pop(),s.isDraws[n]){const h=s.points[n],l=s.lengths[n];i.line(h.x,h.y,h.x,h.y+l)}i.pop()}),$(i,e)},it=o=>{const t=N.setSize("sketch");let s=S.setController();const e=K();let i,a,n,r,h,l;o.setup=async()=>{i=H(e,t),a=O(e),n=v(i,a,e),r=A(a,s,e),l=await X(a,e),o.createCanvas(t,t);const p=S.setGui(o,s,l.se,!0);P(e,p),o.noLoop()},o.draw=()=>{if(l===void 0){o.noLoop();return}o.frameCount%5===0&&U({progress:r,adsrLengths:a.adsrLength,seq:a.seq},10),o.background(255),S.updateController(o,s),a=O(e),n=v(i,a,e),r=A(a,s,e,r),h=J(i,r,e),Y(i,n,h,t,o)}};export{it as sketch};
